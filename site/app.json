[{"name": "app.py", "content": "import json\nimport pandas as pd\nimport plotly.express as px\nfrom shiny import App, ui, render\nfrom shinywidgets import output_widget, render_widget\nfrom pathlib import Path\nimport geopandas as gpd\nimport cartopy.io.shapereader as shpreader\n\n# Load data from JSON file\ndata_path = Path(__file__).parent / \"data.json\"\nwith open(data_path, \"r\", encoding=\"utf-8\") as file:\n    data = pd.read_json(file)\n\n# Clean and prepare the data\ndata['Inception'] = pd.to_datetime(data['Inception'], format='%Y', errors='coerce')\n\n# Safely extract latitude and longitude\ndef extract_coordinate(coord, index):\n    if isinstance(coord, list) and len(coord) > index:\n        return coord[index]\n    return None\n\ndata['Latitude'] = data['Coordinates'].apply(lambda x: extract_coordinate(x, 0))\ndata['Longitude'] = data['Coordinates'].apply(lambda x: extract_coordinate(x, 1))\n\n# Prepare the JSON data for country colors\ncountry_counts = data['Country'].value_counts().to_dict()\ncountry_color_data = json.dumps(country_counts)\n\n# Prepare unique values for dropdowns\nunique_types = [\"All\"] + sorted(data['Type'].unique().tolist())\nunique_countries = [\"All\"] + sorted(data['Country'].unique().tolist())\nunique_cities = [\"All\"] + sorted(data['City'].unique().tolist())\n\n# Load world map data\nworld = gpd.read_file(shpreader.natural_earth(resolution='110m', category='cultural', name='admin_0_countries'))\nworld = world.to_crs(epsg=4326)\nworld_geojson = json.loads(world.to_json())\n\napp_ui = ui.page_sidebar(\n    ui.sidebar(\n        ui.input_select(\"filter_type\", \"Filter by Type\", choices=unique_types),\n        ui.input_select(\"filter_country\", \"Filter by Country\", choices=unique_countries),\n        ui.input_select(\"filter_city\", \"Filter by City\", choices=unique_cities),\n    ),\n    ui.h1(\"WANA Partners Dashboard\"),\n    ui.navset_tab(\n        ui.nav_panel(\"Overview\", \n            ui.h2(\"Data Overview\"),\n            ui.output_data_frame(\"data_table\")\n        ),\n        ui.nav_panel(\"Type\", \n            ui.h2(\"Partners by Type and Country\"),\n            output_widget(\"type_chart\")\n        ),\n        ui.nav_panel(\"Map\", \n            ui.h2(\"Partner Distribution\"),\n            output_widget(\"map\")\n        ),\n        ui.nav_panel(\"Newspaper Timeline\", \n            ui.h2(\"Newspaper Timeline\"),\n            output_widget(\"timeline\")\n        ),\n    )\n)\n\ndef server(input, output, session):\n    @output\n    @render.data_frame\n    def data_table():\n        filtered_data = data\n        if input.filter_type() != \"All\":\n            filtered_data = filtered_data[filtered_data['Type'] == input.filter_type()]\n        if input.filter_country() != \"All\":\n            filtered_data = filtered_data[filtered_data['Country'] == input.filter_country()]\n        if input.filter_city() != \"All\":\n            filtered_data = filtered_data[filtered_data['City'] == input.filter_city()]\n        \n        columns_to_display = ['Institute or newspaper name', 'Country', 'City', 'Type', 'Inception', 'Closure date']\n        display_data = filtered_data[columns_to_display].copy()\n        \n        display_data['Inception'] = display_data['Inception'].dt.strftime('%Y')\n        display_data['Closure date'] = pd.to_datetime(display_data['Closure date'], errors='coerce').dt.strftime('%Y')\n        display_data = display_data.rename(columns={'Institute or newspaper name': 'Name'})\n        display_data = display_data.sort_values('Name')\n        \n        return render.DataGrid(display_data, filters=True, height=\"100%\")\n\n    @output\n    @render_widget\n    def map():\n        filtered_data = data\n        if input.filter_type() != \"All\":\n            filtered_data = filtered_data[filtered_data['Type'] == input.filter_type()]\n        if input.filter_country() != \"All\":\n            filtered_data = filtered_data[filtered_data['Country'] == input.filter_country()]\n        if input.filter_city() != \"All\":\n            filtered_data = filtered_data[filtered_data['City'] == input.filter_city()]\n        \n        # Count partners per country\n        country_counts = filtered_data['Country'].value_counts().reset_index()\n        country_counts.columns = ['Country', 'Count']\n\n        fig = px.choropleth(country_counts, \n                            geojson=world_geojson, \n                            locations='Country', \n                            color='Count',\n                            color_continuous_scale=\"Viridis\",\n                            range_color=(0, country_counts['Count'].max()),\n                            labels={'Count':'Number of Partners'},\n                            hover_name='Country',\n                            hover_data={'Count': True, 'Country': False},\n                            featureidkey=\"properties.NAME\")\n\n        fig.update_geos(showcountries=True, countrycolor=\"Black\", countrywidth=0.5,\n                        showcoastlines=True, coastlinecolor=\"Black\", coastlinewidth=0.5)\n\n        # Calculate the center of the data points\n        center_lat = filtered_data['Latitude'].mean()\n        center_lon = filtered_data['Longitude'].mean()\n\n        fig.update_layout(\n            title_text='Partner Distribution by Country',\n            geo=dict(\n                showframe=False,\n                projection_type='natural earth',\n                center=dict(lat=center_lat, lon=center_lon),\n                # Adjust the zoom level as needed\n                projection_scale=2\n            ),\n            height=600,\n            margin={\"r\":0,\"t\":40,\"l\":0,\"b\":0}\n        )\n\n        # Add scatter plot for individual partners\n        scatter_data = px.scatter_geo(filtered_data,\n                                      lat='Latitude',\n                                      lon='Longitude',\n                                      hover_name='Institute or newspaper name',\n                                      color='Type')\n\n        for trace in scatter_data.data:\n            fig.add_trace(trace)\n\n        # Adjust legend position\n        fig.update_layout(\n            legend=dict(\n                yanchor=\"top\",\n                y=0.99,\n                xanchor=\"left\",\n                x=0.01,\n                bgcolor=\"rgba(255, 255, 255, 0.5)\"\n            )\n        )\n\n        # Simplify hover information for both choropleth and scatter plots\n        fig.update_traces(\n            hovertemplate='%{hovertext}<br>Count: %{z}',\n            selector=dict(type='choropleth')\n        )\n        fig.update_traces(\n            hovertemplate='%{hovertext}',\n            selector=dict(type='scattergeo')\n        )\n\n        return fig\n\n    @output\n    @render_widget\n    def type_chart():\n        filtered_data = data\n        if input.filter_country() != \"All\":\n            filtered_data = filtered_data[filtered_data['Country'] == input.filter_country()]\n        if input.filter_city() != \"All\":\n            filtered_data = filtered_data[filtered_data['City'] == input.filter_city()]\n        \n        type_country_counts = filtered_data.groupby(['Type', 'Country']).size().reset_index(name='Count')\n        \n        fig = px.bar(type_country_counts, \n                     x='Type', \n                     y='Count', \n                     color='Country', \n                     title='Partners by Type and Country',\n                     labels={'Count': 'Number of Partners'},\n                     hover_data=['Country', 'Count'])\n        \n        fig.update_layout(barmode='stack')\n        return fig\n\n    @output\n    @render_widget\n    def timeline():\n        # Filter for newspapers only\n        newspaper_data = data[data['Type'] == 'Newspaper'].copy()\n        \n        # Convert Inception to datetime\n        newspaper_data['Inception'] = pd.to_datetime(newspaper_data['Inception'], format='%Y', errors='coerce')\n        \n        # Handle Closure date\n        newspaper_data['Closure date'] = pd.to_datetime(newspaper_data['Closure date'], format='%Y', errors='coerce')\n        newspaper_data['Closure date'] = newspaper_data['Closure date'].fillna(pd.Timestamp('2024-01-01'))\n        \n        # Apply filters\n        if input.filter_country() != \"All\":\n            newspaper_data = newspaper_data[newspaper_data['Country'] == input.filter_country()]\n        if input.filter_city() != \"All\":\n            newspaper_data = newspaper_data[newspaper_data['City'] == input.filter_city()]\n        \n        # Sort the data by Country and then by Inception date in descending order\n        newspaper_data = newspaper_data.sort_values(['Country', 'Inception'], ascending=[True, False])\n        \n        # Create the timeline\n        fig = px.timeline(newspaper_data, \n                          x_start=\"Inception\", \n                          x_end=\"Closure date\",\n                          y=\"Institute or newspaper name\",\n                          color=\"Country\",\n                          hover_data=[\"Country\", \"City\"])\n        \n        # Customize the layout\n        fig.update_layout(\n            title=\"Newspaper Timeline\",\n            xaxis_title=\"Year\",\n            yaxis_title=\"Newspaper Name\",\n            height=600\n        )\n        \n        # Update traces to show the newspaper name in the hover text\n        fig.update_traces(hovertemplate='<b>%{y}</b><br>Inception: %{x}<br>Closure: %{x_end}<br>Country: %{customdata[0]}<br>City: %{customdata[1]}')\n        \n        # Reverse the y-axis to have the oldest newspapers at the top\n        fig.update_yaxes(autorange=\"reversed\")\n        \n        return fig\n\napp = App(app_ui, server)", "type": "text"}, {"name": "data.json", "content": "[\n    {\n      \"Institute or newspaper name\": \"National Library of Benin\",\n      \"Country\": \"Benin\",\n      \"City\": \"Porto-Novo\",\n      \"Type\": \"Archives\",\n      \"Inception\": \"1975\",\n      \"Coordinates\": [6.5118, 2.6061]\n    },\n    {\n      \"Institute or newspaper name\": \"Le H\u00e9raut\",\n      \"Country\": \"Benin\",\n      \"City\": \"Abomey-Calavi\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1988\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.412947, 2.342869]\n    },\n    {\n      \"Institute or newspaper name\": \"National Archives of Benin\",\n      \"Country\": \"Benin\",\n      \"City\": \"Porto-Novo\",\n      \"Type\": \"Archives\",\n      \"Inception\": \"1914\",\n      \"Coordinates\": [6.511933, 2.606324]\n    },\n    {\n      \"Institute or newspaper name\": \"Fraternit\u00e9\",\n      \"Country\": \"Benin\",\n      \"City\": \"Cotonou\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1999\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.388017, 2.367524]\n    },\n    {\n      \"Institute or newspaper name\": \"Matin Libre\",\n      \"Country\": \"Benin\",\n      \"City\": \"Cotonou\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"2014\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.3711, 2.422464]\n    },\n    {\n      \"Institute or newspaper name\": \"La Croix du B\u00e9nin\",\n      \"Country\": \"Benin\",\n      \"City\": \"Cotonou\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1946\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.367897, 2.427973]\n    },\n    {\n      \"Institute or newspaper name\": \"Le Matinal\",\n      \"Country\": \"Benin\",\n      \"City\": \"Cotonou\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1997\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.370149, 2.48385]\n    },\n    {\n      \"Institute or newspaper name\": \"Civic Academy for Africa's Future\",\n      \"Country\": \"Benin\",\n      \"City\": \"Abomey-Calavi\",\n      \"Type\": \"Education\",\n      \"Inception\": \"2019\",\n      \"Coordinates\": [6.41677, 2.325773]\n    },\n    {\n      \"Institute or newspaper name\": \"La Nation\",\n      \"Country\": \"Benin\",\n      \"City\": \"Cotonou\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1990\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.357045, 2.401843]\n    },\n    {\n        \"Institute or newspaper name\": \"Ehuzu\",\n        \"Country\": \"Benin\",\n        \"City\": \"Cotonou\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1975\",\n        \"Closure date\": \"1990\",\n        \"Coordinates\": [6.357045, 2.401843]\n      },\n      {\n        \"Institute or newspaper name\": \"Daho-Express\",\n        \"Country\": \"Benin\",\n        \"City\": \"Cotonou\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1969\",\n        \"Closure date\": \"1975\",\n        \"Coordinates\": [6.357045, 2.401843]\n      },\n    {\n      \"Institute or newspaper name\": \"LASDEL Parakou\",\n      \"Country\": \"Benin\",\n      \"City\": \"Parakou\",\n      \"Type\": \"Education\",\n      \"Inception\": null,\n      \"Coordinates\": [9.341821, 2.592845]\n    },\n    {\n      \"Institute or newspaper name\": \"Autorit\u00e9 Nationale de la Presse\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Organisation\",\n      \"Inception\": null,\n      \"Coordinates\": [5.391243, -3.986900]\n    },\n    {\n      \"Institute or newspaper name\": \"Archives Nationales de C\u00f4te d'Ivoire\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Archives\",\n      \"Inception\": \"1976\",\n      \"Coordinates\": [5.320437, -4.021263]\n    },\n    {\n      \"Institute or newspaper name\": \"Le Temps\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"2003\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.356952, -3.977041]\n    },\n    {\n      \"Institute or newspaper name\": \"Centre de Recherche et d'Action pour la Paix\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Library\",\n      \"Inception\": \"1962\",\n      \"Coordinates\": [5.33969, -4.0006]\n    },\n    {\n      \"Institute or newspaper name\": \"Le Jour Plus\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"2003\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.376238, -3.996232]\n    },\n    {\n        \"Institute or newspaper name\": \"Le Jour\",\n        \"Country\": \"C\u00f4te d'Ivoire\",\n        \"City\": \"Abidjan\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1994\",\n        \"Closure date\": \"2003\",\n        \"Coordinates\": [5.376238, -3.996232]\n      },\n    {\n      \"Institute or newspaper name\": \"Le Patriote\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1991\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.279551, -3.978055]\n    },\n    {\n      \"Institute or newspaper name\": \"L'inter\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1998\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.298293, -3.982263]\n    },\n    {\n      \"Institute or newspaper name\": \"Soir Info\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1994\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.298293, -3.982263]\n    },\n    {\n      \"Institute or newspaper name\": \"Notre Voie\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1997\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.362541, -3.959885]\n    },\n    {\n        \"Institute or newspaper name\": \"La Voie\",\n        \"Country\": \"C\u00f4te d'Ivoire\",\n        \"City\": \"Abidjan\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1991\",\n        \"Closure date\": \"1997\",\n        \"Coordinates\": [5.362541, -3.959885]\n      },\n      {\n        \"Institute or newspaper name\": \"Le Nouvel Horizon\",\n        \"Country\": \"C\u00f4te d'Ivoire\",\n        \"City\": \"Abidjan\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1990\",\n        \"Closure date\": null,\n        \"Coordinates\": [5.362541, -3.959885]\n      },\n    {\n      \"Institute or newspaper name\": \"Fraternit\u00e9 Matin\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1964\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.344436, -4.018549]\n    },\n    {\n        \"Institute or newspaper name\": \"Fraternit\u00e9 Hebdo\",\n        \"Country\": \"C\u00f4te d'Ivoire\",\n        \"City\": \"Abidjan\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1969\",\n        \"Closure date\": null,\n        \"Coordinates\": [5.344436, -4.018549]\n      },\n      {\n        \"Institute or newspaper name\": \"Ivoire Dimanche\",\n        \"Country\": \"C\u00f4te d'Ivoire\",\n        \"City\": \"Abidjan\",\n        \"Type\": \"Newspaper\",\n        \"Inception\": \"1971\",\n        \"Closure date\": \"1990\",\n        \"Coordinates\": [5.344436, -4.018549]\n      },  \n    {\n      \"Institute or newspaper name\": \"Groupement des \u00c9diteurs de Presse de C\u00f4te d'Ivoire\",\n      \"Country\": \"C\u00f4te d'Ivoire\",\n      \"City\": \"Abidjan\",\n      \"Type\": \"Organisation\",\n      \"Inception\": null,\n      \"Coordinates\": [5.346763, -4.017048]\n    },\n    {\n      \"Institute or newspaper name\": \"Balme Library\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Library\",\n      \"Inception\": \"1948\",\n      \"Coordinates\": [5.65197, -0.187028]\n    },\n    {\n      \"Institute or newspaper name\": \"Daily Graphic\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1950\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.554803, -0.217079]\n    },\n    {\n      \"Institute or newspaper name\": \"The Mirror\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1953\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.554803, -0.217079]\n    },\n    {\n      \"Institute or newspaper name\": \"The Spectator\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1969\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.554803, -0.217079]\n    },\n    {\n      \"Institute or newspaper name\": \"Daily Guide\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1984\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.575921, -0.201627]\n    },\n    {\n      \"Institute or newspaper name\": \"The Ghanaian Times\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1957\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.569508, -0.221906]\n    },\n    {\n      \"Institute or newspaper name\": \"The Ghanaian Observer\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"2006\",\n      \"Closure date\": null,\n      \"Coordinates\": [5.577693, -0.208109]\n    },\n    {\n      \"Institute or newspaper name\": \"Ghana Library Authority\",\n      \"Country\": \"Ghana\",\n      \"City\": \"Accra\",\n      \"Type\": \"Archives\",\n      \"Inception\": \"1950\",\n      \"Coordinates\": [5.5447, -0.2058]\n    },\n    {\n      \"Institute or newspaper name\": \"Biblioth\u00e8que et Archives nationales du Togo\",\n      \"Country\": \"Togo\",\n      \"City\": \"Lom\u00e9\",\n      \"Type\": \"Archives\",\n      \"Inception\": \"1969\",\n      \"Coordinates\": [6.129117, 1.218427]\n    },\n    {\n      \"Institute or newspaper name\": \"University of Lom\u00e9\",\n      \"Country\": \"Togo\",\n      \"City\": \"Lom\u00e9\",\n      \"Type\": \"Education\",\n      \"Inception\": \"1970\",\n      \"Coordinates\": [6.173669, 1.215866]\n    },\n    {\n      \"Institute or newspaper name\": \"L'Alternative\",\n      \"Country\": \"Togo\",\n      \"City\": \"Lom\u00e9\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"2008\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.131944, 1.222778]\n    },\n    {\n      \"Institute or newspaper name\": \"Libert\u00e9\",\n      \"Country\": \"Togo\",\n      \"City\": \"Lom\u00e9\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"2005\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.18998, 1.15607]\n    },\n    {\n      \"Institute or newspaper name\": \"La D\u00e9p\u00eache\",\n      \"Country\": \"Togo\",\n      \"City\": \"Lom\u00e9\",\n      \"Type\": \"Newspaper\",\n      \"Inception\": \"1993\",\n      \"Closure date\": null,\n      \"Coordinates\": [6.158767, 1.212996]\n    }\n  ]", "type": "text"}]